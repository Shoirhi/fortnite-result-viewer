---
import type {
    CumulativeStandingEntry,
    MatchPlacementEntry,
} from "@/lib/standings";

type Props = {
    entries: Array<CumulativeStandingEntry | MatchPlacementEntry>;
    variant: "event" | "match";
    limit?: number;
};

const { entries, variant, limit } = Astro.props as Props;
const isEventSummary = variant === "event";
const resolvedLimit =
    typeof limit === "number" && Number.isFinite(limit) && limit > 0
        ? Math.floor(limit)
        : entries.length;
const visibleEntries = entries.slice(0, resolvedLimit);
---

<div class="flex-1 overflow-hidden">
    <table class="h-full min-w-full text-left text-sm">
        <thead class="text-2xl font-bold text-black">
            <tr>
                <th class="px-4 py-3" />
                {isEventSummary && <th class="px-4 py-3" />}
                <th class="px-4 py-3" />
                <th class="px-4 py-3" />
                <th class="px-4 py-3 text-right whitespace-nowrap">
                    合計
                </th>
                <th class="px-4 py-3 text-right whitespace-nowrap">
                    順位PT
                </th>
                <th class="px-4 py-3 text-right whitespace-nowrap">
                    撃破PT
                </th>
                {isEventSummary && (
                    <th class="px-4 py-3 text-right whitespace-nowrap">
                        VRs
                    </th>
                )}
            </tr>
        </thead>
        <tbody class="divide-y divide-black/10">
            {visibleEntries.map((entry) => {
                const summaryEntry = entry as CumulativeStandingEntry;
                const matchEntry = entry as MatchPlacementEntry;
                const placement = isEventSummary
                    ? summaryEntry.placement
                    : matchEntry.rank;
                const rankChange = isEventSummary
                    ? summaryEntry.rankChange
                    : 0;
                const team = entry.team;
                const members =
                    team.members?.length > 0
                        ? team.members.join(" + ")
                        : team.playerName;
                const score = isEventSummary
                    ? summaryEntry.totals.totalScore
                    : matchEntry.detail.score;
                const placementScore = isEventSummary
                    ? summaryEntry.totals.placementScore
                    : matchEntry.detail.placementScore;
                const eliminationScore = isEventSummary
                    ? summaryEntry.totals.eliminationScore
                    : matchEntry.detail.eliminationScore;
                const vrCount = isEventSummary ? team.countVR : undefined;

                return (
                    <tr class="transition hover:text-black h-[90px] break-all">
                        <td class="w-21 align-middle">
                            <span class="inline-flex w-full h-full shrink-0 items-center justify-center bg-[#AE0101] text-5xl font-black leading-none text-white tabular-nums">
                                {placement}
                            </span>
                        </td>
                        {isEventSummary && (
                            <td class="px-1 whitespace-nowrap w-full h-full inline-flex items-center justify-center tabular-nums text-3xl">
                                {rankChange > 0 ? (
                                    <div class="text-emerald-700 tabular-nums">
                                        ▲ {rankChange}
                                    </div>
                                ) : rankChange < 0 ? (
                                    <div class="text-rose-700 tabular-nums">
                                        ▼ {Math.abs(rankChange)}
                                    </div>
                                ) : (
                                    <div class="text-black/60 tabular-nums">
                                        －
                                    </div>
                                )}
                            </td>
                        )}
                        <td class="px-2 text-3xl leading-[1.1] h-full font-bold align-middle">
                            {team.teamName}
                        </td>
                        <td class="px-2 text-2xl leading-[1.2] h-full text-black whitespace-normal truncate font-bold align-middle">
                            {members}
                        </td>
                        <td class="px-2 text-right h-full text-5xl font-bold tabular-nums whitespace-nowrap align-middle tracking-tighter">
                            {score}
                        </td>
                        <td class="px-5 text-right h-full text-3xl font-bold tracking-tighter text-black/90 tabular-nums whitespace-nowrap align-middle">
                            {placementScore}
                        </td>
                        <td class="px-5 text-right h-full text-3xl font-bold tracking-tighter text-black/90 tabular-nums whitespace-nowrap align-middle">
                            {eliminationScore}
                        </td>
                        {isEventSummary && (
                            <td class="px-5 text-right h-full text-3xl font-bold tracking-tighter text-black/90 tabular-nums whitespace-nowrap align-middle">
                                {vrCount}
                            </td>
                        )}
                    </tr>
                );
            })}
        </tbody>
    </table>
</div>
